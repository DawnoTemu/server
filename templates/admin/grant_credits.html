{% extends 'admin/custom_base.html' %}

{% block title %}Grant Story Points - {{ user.email }} - DawnoTemu Admin{% endblock %}

{% block body %}
<!-- Page Header -->
<div class="mb-8">
    <div class="flex items-center gap-3 mb-3">
        <a href="{{ url_for('user.index_view') }}" class="btn btn-outline">
            <i data-feather="arrow-left" class="w-4 h-4"></i>
            <span>Back to Users</span>
        </a>
    </div>
    <h1 class="text-3xl font-bold text-gray-900 mb-2">Grant Story Points</h1>
    <div class="flex items-center gap-3">
        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-primary to-primary-dark flex items-center justify-center text-white font-bold text-lg">
            {{ user.email[0].upper() }}
        </div>
        <div>
            <p class="text-lg font-semibold text-gray-900">{{ user.email }}</p>
            <p class="text-sm text-gray-500">Current Balance: <span class="font-semibold text-purple-600">{{ user.credits_balance }} points</span></p>
        </div>
    </div>
</div>

<!-- Grant Form Card -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Form Column -->
    <div class="lg:col-span-2">
        <div class="card">
            <div class="card-header">
                <div class="flex items-center gap-2">
                    <i data-feather="gift" class="w-5 h-5"></i>
                    <span>Grant Credits</span>
                </div>
            </div>

            <form method="POST" class="space-y-6" x-data="{
                amount: 0,
                source: 'add_on',
                expiresEnabled: false,
                calculateNewBalance() {
                    return {{ user.credits_balance }} + parseInt(this.amount || 0);
                }
            }">
                <input type="hidden" name="user_id" value="{{ user.id }}" />

                <!-- Amount Field -->
                <div class="form-group">
                    <label for="amount" class="form-label required">
                        Amount (Story Points)
                    </label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                            <i data-feather="hash" class="w-5 h-5 text-gray-400"></i>
                        </div>
                        <input
                            type="number"
                            id="amount"
                            name="amount"
                            x-model="amount"
                            min="1"
                            required
                            class="form-control pl-12"
                            placeholder="Enter amount"
                        >
                    </div>
                    <p class="text-xs text-gray-500 mt-1">1 story point = 1,000 characters of narration</p>
                </div>

                <!-- Source Field -->
                <div class="form-group">
                    <label for="source" class="form-label required">
                        Source
                    </label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                            <i data-feather="layers" class="w-5 h-5 text-gray-400"></i>
                        </div>
                        <select
                            id="source"
                            name="source"
                            x-model="source"
                            class="form-control pl-12 appearance-none"
                        >
                            <option value="add_on">Add-On (purchased credits)</option>
                            <option value="referral">Referral (referral bonus)</option>
                            <option value="free">Free (promotional credits)</option>
                            <option value="monthly">Monthly (subscription)</option>
                            <option value="event">Event (special promotion)</option>
                        </select>
                        <div class="absolute inset-y-0 right-0 pr-4 flex items-center pointer-events-none">
                            <i data-feather="chevron-down" class="w-5 h-5 text-gray-400"></i>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Credit source affects expiration and consumption order</p>
                </div>

                <!-- Reason Field -->
                <div class="form-group">
                    <label for="reason" class="form-label">
                        Reason (optional)
                    </label>
                    <div class="relative">
                        <div class="absolute top-3 left-4 pointer-events-none">
                            <i data-feather="message-circle" class="w-5 h-5 text-gray-400"></i>
                        </div>
                        <textarea
                            id="reason"
                            name="reason"
                            rows="3"
                            class="form-control pl-12"
                            placeholder="admin_grant, customer_service, compensation, etc."
                        ></textarea>
                    </div>
                </div>

                <!-- Expiration Field -->
                <div class="form-group">
                    <label class="flex items-center gap-2 cursor-pointer mb-2">
                        <input
                            type="checkbox"
                            x-model="expiresEnabled"
                            class="w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary focus:ring-2"
                        >
                        <span class="form-label !mb-0">Set Expiration Date</span>
                    </label>

                    <div x-show="expiresEnabled" x-transition class="relative">
                        <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                            <i data-feather="calendar" class="w-5 h-5 text-gray-400"></i>
                        </div>
                        <input
                            type="datetime-local"
                            id="expires_at"
                            name="expires_at"
                            class="form-control pl-12"
                            :disabled="!expiresEnabled"
                        >
                    </div>
                    <p class="text-xs text-gray-500 mt-1" x-show="expiresEnabled">Credits will expire on this date and be removed from the user's balance</p>
                </div>

                <!-- Submit Buttons -->
                <div class="flex items-center gap-3 pt-6 border-t border-gray-200">
                    <button type="submit" class="btn btn-primary btn-lg flex-1">
                        <i data-feather="check" class="w-5 h-5"></i>
                        <span>Grant <span x-text="amount || 0"></span> Points</span>
                    </button>
                    <a href="{{ url_for('user.index_view') }}" class="btn btn-outline btn-lg">
                        <span>Cancel</span>
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Info Sidebar -->
    <div class="space-y-6">
        <!-- Preview Card -->
        <div class="card" x-data="{ amount: 0 }">
            <div class="card-header">
                <div class="flex items-center gap-2">
                    <i data-feather="eye" class="w-5 h-5"></i>
                    <span>Preview</span>
                </div>
            </div>

            <div class="space-y-4">
                <div class="flex items-center justify-between p-3 rounded-lg bg-gray-50">
                    <span class="text-sm text-gray-600">Current Balance</span>
                    <span class="font-semibold text-lg">{{ user.credits_balance }}</span>
                </div>

                <div class="flex items-center justify-center">
                    <i data-feather="plus" class="w-5 h-5 text-primary"></i>
                </div>

                <div class="flex items-center justify-between p-3 rounded-lg bg-purple-50">
                    <span class="text-sm text-purple-600 font-semibold">Grant Amount</span>
                    <span class="font-semibold text-lg text-purple-600" x-text="amount || 0"></span>
                </div>

                <div class="border-t-2 border-dashed border-gray-200"></div>

                <div class="flex items-center justify-between p-4 rounded-lg bg-gradient-to-br from-primary to-primary-dark text-white">
                    <span class="text-sm font-semibold">New Balance</span>
                    <span class="font-bold text-2xl" x-text="{{ user.credits_balance }} + parseInt(amount || 0)"></span>
                </div>
            </div>
        </div>

        <!-- Info Card -->
        <div class="card">
            <div class="card-header">
                <div class="flex items-center gap-2">
                    <i data-feather="info" class="w-5 h-5"></i>
                    <span>Credit Sources</span>
                </div>
            </div>

            <div class="space-y-3 text-sm">
                <div>
                    <div class="flex items-center gap-2 mb-1">
                        <span class="badge badge-secondary">add_on</span>
                        <span class="font-semibold text-gray-900">Add-On</span>
                    </div>
                    <p class="text-xs text-gray-600 ml-6">Purchased credits, no expiration</p>
                </div>

                <div>
                    <div class="flex items-center gap-2 mb-1">
                        <span class="badge badge-warning">referral</span>
                        <span class="font-semibold text-gray-900">Referral</span>
                    </div>
                    <p class="text-xs text-gray-600 ml-6">Bonus for referrals, no expiration</p>
                </div>

                <div>
                    <div class="flex items-center gap-2 mb-1">
                        <span class="badge badge-secondary">free</span>
                        <span class="font-semibold text-gray-900">Free</span>
                    </div>
                    <p class="text-xs text-gray-600 ml-6">Promotional credits, may expire</p>
                </div>

                <div>
                    <div class="flex items-center gap-2 mb-1">
                        <span class="badge badge-info">monthly</span>
                        <span class="font-semibold text-gray-900">Monthly</span>
                    </div>
                    <p class="text-xs text-gray-600 ml-6">Subscription credits, expires monthly</p>
                </div>

                <div>
                    <div class="flex items-center gap-2 mb-1">
                        <span class="badge badge-success">event</span>
                        <span class="font-semibold text-gray-900">Event</span>
                    </div>
                    <p class="text-xs text-gray-600 ml-6">Special event credits, may expire</p>
                </div>
            </div>
        </div>

        <!-- Consumption Order Card -->
        <div class="card">
            <div class="card-header">
                <div class="flex items-center gap-2">
                    <i data-feather="list" class="w-5 h-5"></i>
                    <span>Consumption Order</span>
                </div>
            </div>

            <ol class="space-y-2 text-sm">
                <li class="flex items-center gap-2">
                    <span class="flex items-center justify-center w-6 h-6 rounded-full bg-green-100 text-green-600 text-xs font-bold">1</span>
                    <span>Event (soonest expiring first)</span>
                </li>
                <li class="flex items-center gap-2">
                    <span class="flex items-center justify-center w-6 h-6 rounded-full bg-blue-100 text-blue-600 text-xs font-bold">2</span>
                    <span>Monthly (soonest expiring first)</span>
                </li>
                <li class="flex items-center gap-2">
                    <span class="flex items-center justify-center w-6 h-6 rounded-full bg-yellow-100 text-yellow-600 text-xs font-bold">3</span>
                    <span>Referral</span>
                </li>
                <li class="flex items-center gap-2">
                    <span class="flex items-center justify-center w-6 h-6 rounded-full bg-purple-100 text-purple-600 text-xs font-bold">4</span>
                    <span>Add-On</span>
                </li>
                <li class="flex items-center gap-2">
                    <span class="flex items-center justify-center w-6 h-6 rounded-full bg-gray-100 text-gray-600 text-xs font-bold">5</span>
                    <span>Free</span>
                </li>
            </ol>
        </div>
    </div>
</div>

<!-- Initialize Icons -->
<script>
    feather.replace();
</script>
{% endblock %}
